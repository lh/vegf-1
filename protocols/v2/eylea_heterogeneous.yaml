# Eylea Treat and Extend Protocol with Heterogeneity v1.0
# Based on Seven-UP study showing enormous patient variability
# ALL parameters must be explicitly defined - no defaults allowed

name: "Eylea Treat and Extend - Heterogeneous"
version: "1.0"
created_date: "2024-01-18"
author: "Clinical Team"
description: "Treat-and-extend protocol with patient heterogeneity based on Seven-UP study data"

# Protocol timing parameters (NO DEFAULTS)
protocol_type: "treat_and_extend"
min_interval_days: 28  # 4 weeks - minimum time between visits
max_interval_days: 112  # 16 weeks - maximum extension
extension_days: 14  # 2 weeks - extend by this when stable
shortening_days: 14  # 2 weeks - shorten by this when active

# Disease state transitions - all probabilities must sum to 1.0
disease_transitions:
  NAIVE:
    NAIVE: 0.0        # Cannot remain naive after first assessment
    STABLE: 0.3       # 30% achieve stability quickly
    ACTIVE: 0.6       # 60% have active disease
    HIGHLY_ACTIVE: 0.1  # 10% have severe disease
  STABLE:
    NAIVE: 0.0        # Cannot return to naive
    STABLE: 0.85      # 85% remain stable
    ACTIVE: 0.15      # 15% develop recurrence
    HIGHLY_ACTIVE: 0.0  # Rare to jump directly to highly active
  ACTIVE:
    NAIVE: 0.0        # Cannot return to naive
    STABLE: 0.4       # 40% achieve stability with treatment
    ACTIVE: 0.5       # 50% remain active
    HIGHLY_ACTIVE: 0.1  # 10% worsen despite treatment
  HIGHLY_ACTIVE:
    NAIVE: 0.0        # Cannot return to naive
    STABLE: 0.1       # 10% achieve stability (rare)
    ACTIVE: 0.4       # 40% improve to active
    HIGHLY_ACTIVE: 0.5  # 50% remain highly active

# Treatment effect multipliers on transition probabilities
treatment_effect_on_transitions:
  NAIVE:
    STABLE: 2.0       # 2x more likely to become stable with treatment
    ACTIVE: 0.5       # 0.5x less likely to be active
    HIGHLY_ACTIVE: 0.33  # 0.33x less likely to be highly active
  STABLE:
    STABLE: 1.2       # 1.2x more likely to remain stable
    ACTIVE: 0.8       # 0.8x less likely to recur
    HIGHLY_ACTIVE: 0.5  # 0.5x less likely to worsen (if possible)
  ACTIVE:
    STABLE: 1.5       # 1.5x more likely to stabilize
    ACTIVE: 0.8       # 0.8x less likely to remain active
    HIGHLY_ACTIVE: 0.5  # 0.5x less likely to worsen
  HIGHLY_ACTIVE:
    STABLE: 2.0       # 2x more likely to improve (still rare)
    ACTIVE: 1.5       # 1.5x more likely to improve
    HIGHLY_ACTIVE: 0.67  # 0.67x less likely to remain highly active

# Vision change per visit by disease state (negative = decline)
vision_change_per_visit:
  NAIVE: -0.5         # Mild decline if untreated
  STABLE: 0.5         # Slight improvement when stable
  ACTIVE: -2.0        # Moderate decline when active
  HIGHLY_ACTIVE: -4.0 # Severe decline when highly active

# Standard deviation for vision changes
vision_change_std: 2.0  # Letters

# Baseline vision distribution
baseline_vision:
  distribution: "normal"
  mean: 60.0          # ETDRS letters
  std: 10.0           # Standard deviation

# Heterogeneity configuration - enables patient variability
heterogeneity:
  enabled: true
  version: '1.0'
  
  # Patient trajectory classes based on Seven-UP study patterns
  trajectory_classes:
    good_responders:
      proportion: 0.25
      description: "Patients who maintain vision near baseline with good treatment response"
      parameters:
        treatment_effect_multiplier:
          distribution: lognormal
          mean: 1.3
          std: 0.2
          comment: "30% better treatment response on average"
        disease_progression_multiplier:
          distribution: lognormal
          mean: 0.7
          std: 0.15
          comment: "30% slower disease progression"
    
    moderate_decliners:
      proportion: 0.40
      description: "Patients with gradual vision decline over time"
      parameters:
        treatment_effect_multiplier:
          distribution: lognormal
          mean: 1.0
          std: 0.3
          comment: "Average treatment response with variability"
        disease_progression_multiplier:
          distribution: lognormal
          mean: 1.0
          std: 0.3
          comment: "Average disease progression"
    
    poor_responders:
      proportion: 0.35
      description: "Patients with rapid vision decline despite treatment"
      parameters:
        treatment_effect_multiplier:
          distribution: lognormal
          mean: 0.7
          std: 0.2
          comment: "30% worse treatment response"
        disease_progression_multiplier:
          distribution: lognormal
          mean: 1.5
          std: 0.4
          comment: "50% faster disease progression"
  
  # Additional patient-specific parameters
  patient_parameters:
    # Treatment resistance development (tachyphylaxis)
    resistance_rate:
      distribution: beta
      alpha: 2
      beta: 5
      comment: "Most patients (mode ~0.2) develop mild resistance, some develop significant resistance"
    
    # Maximum achievable vision (ceiling effect)
    max_achievable_va_offset:
      distribution: normal
      mean: 10
      std: 15
      comment: "Added to baseline VA to determine individual ceiling (capped at 85 letters)"
  
  # Rare catastrophic events that permanently affect vision
  catastrophic_events:
    geographic_atrophy:
      probability_per_month: 0.001
      vision_impact:
        distribution: uniform
        min: -30
        max: -10
      permanent: true
      comment: "Development of geographic atrophy causes significant vision loss"
    
    subretinal_fibrosis:
      probability_per_month: 0.0005
      vision_impact:
        distribution: normal
        mean: -20
        std: 5
      permanent: true
      max_va_reduction: 20
      comment: "Fibrosis reduces maximum achievable vision"
  
  # Variance decomposition (for validation)
  variance_components:
    between_patient: 0.65  # 65% of variance is between patients
    within_patient: 0.25   # 25% is within-patient variation
    measurement: 0.10      # 10% is measurement noise
  
  # Validation targets from Seven-UP study
  validation:
    mean_change_7_years: -8.6
    std_7_years: 30
    year2_year7_correlation: 0.97
    proportion_above_70: 0.25
    proportion_below_35: 0.35
    comment: "Target outcomes for model validation against Seven-UP study"
  
  # Optional debug settings
  debug: false
  debug_output:
    - patient_assignments    # Log trajectory class assignments
    - distribution_samples   # Log sampled parameter values
    - validation_metrics     # Log validation calculations

# Time-based model parameters (if applicable)
# Uncomment below to make this a time-based protocol
# model_type: "time_based"
# transition_model: "fortnightly"
# parameters_directory: "./parameters"